<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Weather Project</title>
    <link rel="stylesheet" href="css/weather_map.css">
    <script src="js/mapbox-geocode-utils.js"></script>
    <script src='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css' rel='stylesheet' />
</head>
<body>
<div id="container">
<div id="top-bar"><span id="page-title">Weather App</span> <span id="current-city">Current city: San Antonio</span></div>
<div id="search-bar">
    place
    <input type="text">
    <button type="button">search</button>
</div>

<div id="weather-cards">
</div>
</div>
<!--&lt;!&ndash;mapbox geocoder&ndash;&gt;-->
<!--<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.min.js"></script>-->
<!--<link-->
<!--        rel="stylesheet"-->
<!--        href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v4.5.1/mapbox-gl-geocoder.css"-->
<!--        type="text/css"-->
<!--/>-->
<!--&lt;!&ndash; Promise polyfill script required to use Mapbox GL Geocoder in IE 11 &ndash;&gt;-->
<!--<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>-->
<!--<script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>-->
<div id='map'></div>
<!--jquery keys-->
<script src="https://code.jquery.com/jquery-2.2.4.min.js"
        integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="
        crossorigin="anonymous"></script>

<!--mapbox keys-->
<script src="js/keys.js"></script>

<script>
    "use strict";

    var weatherUrl = 'https://api.openweathermap.org/data/2.5/onecall';
    var weatherOptions = {
        lat: 29.4241,
        lon: -98.4936,
        appid: OPEN_WEATHER_APPID,
        exclude: 'minutely, current, hourly',
        units: 'imperial',
        timezone: 'Chicago'
    };
    // updateWeather(weatherOptions);

    function simpleDate(str) {
        str = str.toLocaleDateString();
        str = str.split('/');
        if(str[0].length < 2)
            str[0] = '0' + str[0];
        if(str[1].length < 2)
            str[1] = '0' + str[1];
        str = str.join("-")
        return str;
    }

     // function updateWeather () {
     //    $('#weather-cards').html("deleted");
        $.get(weatherUrl, weatherOptions).done(function (data) {
            console.log(data);

            // var todayDate = new Date(data[0].dt + 1000);
            // console.log(todayDate.toLocaleDateString());

            var totalHtml = "";

            for (var i = 0; i < 5; i++) {
                var html = "<ul class='weather-item-list' id='list-index-" + i + "'>";
                html += "<li class='weather-data'>" + simpleDate(new Date(data.daily[i].dt * 1000)) + "</li>";
                html += "<li class='weather-data'> low: " + data.daily[i].temp.min + "째F / <br>" + "high: " + data.daily[i].temp.max + "째F</li>";
                html += "<li class='weather-data'>" + "<image src='http://openweathermap.org/img/w/" + data.daily[i].weather[0].icon + ".png'</li>";
                html += "<li class='weather-data'>Description: <strong>" + data.daily[i].weather[0].description + "</strong></li>";
                html += "<li class='weather-data'>Humidity: <strong>" + data.daily[i].humidity + "</strong></li>";
                html += "<li class='weather-data'>Wind Speed: <strong>" + data.daily[i].wind_speed + "</strong></li>";
                html += "<li class='weather-data'>Pressure: <strong>" + data.daily[i].pressure + "</strong></li>";
                html += "</ul>";

                totalHtml += html;
            }
            $('#weather-cards').html(totalHtml);
        })
    // }

    mapboxgl.accessToken = MAPBOX_KEY;

    var map = new mapboxgl.Map({
        container: 'map',
        zoom: 10,
        center: [-98.4916, 29.42532],
        style: 'mapbox://styles/mapbox/streets-v9'
    });

    var marker = new mapboxgl.Marker();
    marker
        .setLngLat([-98.4916, 29.42532])
        .addTo(map)
        .setDraggable(true);

    console.log(marker.getLngLat());

    marker.on('dragend', function () {
        renderNewCards({
                lat: marker.getLngLat().lat,
                lon: marker.getLngLat().lng,
                appid: OPEN_WEATHER_APPID,
                exclude: 'minutely, current, hourly',
                units: 'imperial',
                timezone: 'Chicago'
        });
    })

    var newWeatherOptions = {};
    function setGeocode(input) {
        geocode(input, MAPBOX_KEY).then(function (result) {
            console.log(result);
            map.setCenter(result);
            newWeatherOptions = {
                lat: result[1],
                lon: result[0],
                appid: OPEN_WEATHER_APPID,
                exclude: 'minutely, current, hourly',
                units: 'imperial',
                timezone: 'Chicago'
            };
        });
    }

    function renderNewCards(newWeatherOptions) {
        $.get(weatherUrl, newWeatherOptions).done(function (data) {
            var totalHtml = "";
            $('#weather-cards').html('');
            for (var i = 0; i < 5; i++) {
                var html = "<ul class='weather-item-list' id='list-index-" + i + "'>";
                html += "<li class='weather-data'>" + simpleDate(new Date(data.daily[i].dt * 1000)) + "</li>";
                html += "<li class='weather-data'> low: " + data.daily[i].temp.min + "째F / <br>" + "high: " + data.daily[i].temp.max + "째F</li>";
                html += "<li class='weather-data'>" + "<image src='http://openweathermap.org/img/w/" + data.daily[i].weather[0].icon + ".png'</li>";
                html += "<li class='weather-data'>Description: <strong>" + data.daily[i].weather[0].description + "</strong></li>";
                html += "<li class='weather-data'>Humidity: <strong>" + data.daily[i].humidity + "</strong></li>";
                html += "<li class='weather-data'>Wind Speed: <strong>" + data.daily[i].wind_speed + "</strong></li>";
                html += "<li class='weather-data'>Pressure: <strong>" + data.daily[i].pressure + "</strong></li>";
                html += "</ul>";
                totalHtml += html;
        }
            $('#weather-cards').html(totalHtml);
        })
    }

    $('button').click(function (e) {
        e.preventDefault();
        geocode($('input').val(), MAPBOX_KEY).then(function (result) {
            marker.setLngLat(result);
            renderNewCards({
                lat: marker.getLngLat().lat,
                lon: marker.getLngLat().lng,
                appid: OPEN_WEATHER_APPID,
                exclude: 'minutely, current, hourly',
                units: 'imperial',
                timezone: 'Chicago'
            });
            map.flyTo({ center: result});
        });
        console.log(marker.getLngLat());
    });
</script>
</body>
</html>